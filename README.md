# お悔やみ情報パイプライン (okuyami)

山梨日日新聞のお悔やみ情報を毎日自動取得し、解析・整形してGitHub Pagesに公開するためのパイプラインです。以下のステップを実行します。

1. **取得 (Scrape)**: Webサイトからお悔やみ情報をSeleniumでスクレイピング
2. **解析 (Parse)**: テキストをCSV/Markdownに構造化
3. **公開 (Publish)**: MarkdownをJekyll形式に変換しGitHub Pagesへコミット＆プッシュ
4. **通知 (Notify)**: LINE/Discordへ処理結果を通知（オプション）

---

## 目次

- [お悔やみ情報パイプライン (okuyami)](#お悔やみ情報パイプライン-okuyami)
  - [目次](#目次)
  - [主な機能](#主な機能)
  - [フォルダ構成](#フォルダ構成)
  - [セットアップ](#セットアップ)
  - [利用方法](#利用方法)
    - [1. 取得 (Scrape)](#1-取得-scrape)
    - [2. 解析 (Parse)](#2-解析-parse)
    - [3. 公開 (Publish)](#3-公開-publish)
    - [4. 通知 (Notify)](#4-通知-notify)
  - [設定ファイル](#設定ファイル)
  - [運用上のポイント](#運用上のポイント)
  - [トラブルシューティング](#トラブルシューティング)
  - [ライセンス](#ライセンス)

---

## 主な機能

- **スクレイピング**: Seleniumを利用しログイン後に最新お悔やみ情報をテキスト保存
- **テキスト正規化**: 改行／空白統一、全角英数字→半角変換
- **データ解析**: `喪主`の個別抽出、`関係者`の改行整形を含むCSV・Markdown出力
- **CSV拡張**: `喪主`カラムを追加
- **Markdown表示強化**: 関係者フィールドは読点・カンマで分割し改行表示、特定キーワード（例: `NEC`）は赤字強調
- **住所リンク**: Google Maps検索へのリンクを住所セルに追加
- **休刊日検知**: 休刊日・掲載なしを検知しプレースホルダ出力
- **差分コミット**: 変更差分がなければGitHub Pagesへのコミットをスキップ
- **通知**: LINE/Discord通知機能（Messaging API/Webhook）

## フォルダ構成

```
okuyami/                    # ルートディレクトリ
├── okuyami_data/           # スクレイピング結果 (テキスト)
├── okuyami_output/         # 解析結果 (CSV, Markdown)
├── _posts/                  # GitHub Pages 投稿先 (サブモジュール等)
├── selenium_okuyami_scraper.py
├── parse_and_format_obituary.py
├── upload_to_github_pages.py
├── send_line_stats.py
└── auto_upload.bat          # PowerShellバッチ（全工程まとめて実行）
```

## セットアップ

1. リポジトリをクローンし移動
   ```powershell
   git clone https://github.com/MiMicroAG/okuyami.git
   cd okuyami
   ```
2. Python環境構築 (3.8+推奨)
   ```powershell
   python -m venv env
   .\env\Scripts\Activate.ps1
   pip install -r requirements.txt
   ```
3. `config_sample.ini` をコピーし `config.ini` を編集
   - `[selenium]`: URL, ログイン情報, headless設定
   - `[github]`: GitHub Pagesリポジトリパス
   - `[line]`, `[discord]`: 通知用APIキー/Webhook URL

## 利用方法

### 1. 取得 (Scrape)
```powershell
python selenium_okuyami_scraper.py --auto
``` 
または任意日付:
```powershell
python selenium_okuyami_scraper.py --date YYYY-MM-DD
```

### 2. 解析 (Parse)
テキストからCSV/Markdownを生成:
```powershell
python parse_and_format_obituary.py --file .\okuyami_data\okuyami_YYYYMMDD.txt --output-dir .\okuyami_output
```
既存CSVのみMarkdown再生成:
```powershell
python parse_and_format_obituary.py --csv .\okuyami_output\*.csv --output-dir .\okuyami_output
```

### 3. 公開 (Publish)
```powershell
python upload_to_github_pages.py --repo "C:\path\to\okuyami-info"
```

### 4. 通知 (Notify)
LINE通知:
```powershell
python send_line_stats.py
```
Discord通知はコード内`common_utils.send_discord_alert()`を呼び出し

一括実行 (Scrape→Parse→Publish→Notify):
```powershell
.\auto_upload.bat
```

## 設定ファイル

- `config_sample.ini` を参照して `config.ini` に必要情報を設定
- Windows PowerShellで実行する前に `chcp 65001` でUTF-8モード設定を推奨

## 運用上のポイント

- **差分コミット**: 変更がない場合はGitHub Pagesへのcommit/pushをスキップ
- **ENTRY_COUNT**: バッチ実行ログに処理件数を表示
- **重複ポリシー**: `喪主`と`関係者`の重複ルールは`parse_and_format_obituary.py`で設定可能

## トラブルシューティング

- **スクレイピング失敗**: `--no-headless`でブラウザ表示デバッグ
- **CSV読み込みエラー**: `utf-8-sig`エンコーディングで再読込
- **Git認証エラー**: SSHキー/PATの設定を確認
- **通知エラー**: `config.ini`または環境変数のURL/トークンをチェック

## ライセンス

MIT License

---
*Generated by analysis of project scripts.*
